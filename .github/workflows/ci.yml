name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  lint:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: ğŸ“¦ è®¾ç½® Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'
        
    - name: ğŸ“¥ å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: ğŸ” ESLint æ£€æŸ¥
      run: npm run lint
      continue-on-error: true
      
    - name: ğŸ’„ Prettier æ£€æŸ¥
      run: npm run format:check
      continue-on-error: true

  # æ„å»ºæµ‹è¯•
  build:
    name: ğŸ—ï¸ æ„å»ºæµ‹è¯•
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: ğŸ“¦ è®¾ç½® Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'
        
    - name: ğŸ“¥ å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: ğŸ—ï¸ æ„å»ºé¡¹ç›®
      run: npm run build
      continue-on-error: true
      
    - name: ğŸ“¦ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: build-files
        path: dist/
        retention-days: 7

  # åç«¯æµ‹è¯•
  backend-test:
    name: ğŸ–¥ï¸ åç«¯æµ‹è¯•
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: dongpaidi_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: ğŸ“¦ è®¾ç½® Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'
        cache-dependency-path: dongpaidi-backend/package-lock.json
        
    - name: ğŸ“¥ å®‰è£…åç«¯ä¾èµ–
      working-directory: ./dongpaidi-backend
      run: npm ci
      
    - name: ğŸ—„ï¸ æ•°æ®åº“è¿ç§»
      working-directory: ./dongpaidi-backend
      run: npx prisma migrate deploy
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/dongpaidi_test
        
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      working-directory: ./dongpaidi-backend
      run: npm test
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/dongpaidi_test
        NODE_ENV: test

  # å®‰å…¨æ‰«æ
  security:
    name: ğŸ”’ å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: ğŸ“¦ è®¾ç½® Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'
        
    - name: ğŸ“¥ å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: ğŸ”’ npm audit
      run: npm audit --audit-level moderate
      continue-on-error: true
      
    - name: ğŸ” CodeQL åˆ†æ
      uses: github/codeql-action/init@v2
      with:
        languages: javascript
        
    - name: ğŸ” æ‰§è¡Œ CodeQL åˆ†æ
      uses: github/codeql-action/analyze@v2

  # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  deploy-staging:
    name: ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [build, backend-test]
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: ğŸ“¦ ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        name: build-files
        path: dist/
        
    - name: ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
      run: |
        echo "éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
        # è¿™é‡Œæ·»åŠ å®é™…çš„éƒ¨ç½²è„šæœ¬
        
  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name: ğŸŒŸ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [build, backend-test, security]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: ğŸ“¦ ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        name: build-files
        path: dist/
        
    - name: ğŸŒŸ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
      run: |
        echo "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
        # è¿™é‡Œæ·»åŠ å®é™…çš„éƒ¨ç½²è„šæœ¬

  # é€šçŸ¥
  notify:
    name: ğŸ“¢ é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [lint, build, backend-test, security]
    if: always()
    
    steps:
    - name: ğŸ“¢ å‘é€é€šçŸ¥
      run: |
        if [ "${{ needs.lint.result }}" == "success" ] && [ "${{ needs.build.result }}" == "success" ]; then
          echo "âœ… CI/CD æµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼"
        else
          echo "âŒ CI/CD æµæ°´çº¿æ‰§è¡Œå¤±è´¥ï¼"
        fi
