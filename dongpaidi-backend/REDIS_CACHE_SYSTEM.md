# Redisç¼“å­˜ç³»ç»Ÿæ–‡æ¡£

## æ¦‚è¿°

æ‡‚æ‹å¸åç«¯ç³»ç»Ÿé›†æˆäº†å®Œæ•´çš„Redisç¼“å­˜è§£å†³æ–¹æ¡ˆï¼Œæä¾›é«˜æ€§èƒ½çš„æ•°æ®ç¼“å­˜ã€ä¼šè¯ç®¡ç†ã€çƒ­é—¨å†…å®¹æ’è¡Œç­‰åŠŸèƒ½ã€‚

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   APIè¯·æ±‚       â”‚    â”‚   ç¼“å­˜ä¸­é—´ä»¶     â”‚    â”‚   RedisæœåŠ¡     â”‚
â”‚                 â”‚â”€â”€â”€â–¶â”‚                 â”‚â”€â”€â”€â–¶â”‚                 â”‚
â”‚ Express Routes  â”‚    â”‚ Cache Middlewareâ”‚    â”‚ Redis/Mock Redisâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸šåŠ¡é€»è¾‘       â”‚    â”‚   ç¼“å­˜æœåŠ¡       â”‚    â”‚   æ•°æ®å­˜å‚¨       â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ Service Layer   â”‚    â”‚ CacheService    â”‚    â”‚ Memory/Redis DB â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒç»„ä»¶

### 1. Redisé…ç½® (`src/config/redis.ts`)

- **RedisClient**: Rediså®¢æˆ·ç«¯å°è£…
- **è¿æ¥ç®¡ç†**: è‡ªåŠ¨é‡è¿ã€é”™è¯¯å¤„ç†
- **é…ç½®é€‰é¡¹**: ä¸»æœºã€ç«¯å£ã€å¯†ç ã€æ•°æ®åº“ç­‰

### 2. ç¼“å­˜æœåŠ¡ (`src/services/cache.ts`)

- **CacheService**: ç»Ÿä¸€çš„ç¼“å­˜æ“ä½œæ¥å£
- **æ”¯æŒæ•°æ®ç±»å‹**: å­—ç¬¦ä¸²ã€å¯¹è±¡ã€å“ˆå¸Œè¡¨ã€åˆ—è¡¨
- **è¿‡æœŸç®¡ç†**: TTLè®¾ç½®ã€è‡ªåŠ¨æ¸…ç†

### 3. ç¼“å­˜é”®ç®¡ç† (`src/services/cacheKeys.ts`)

- **CacheKeys**: ç»Ÿä¸€çš„ç¼“å­˜é”®å‘½åè§„èŒƒ
- **åˆ†ç±»ç®¡ç†**: ç”¨æˆ·ã€ä½œå“ã€çº¦æ‹ã€æ¶ˆæ¯ç­‰
- **é”®ç”Ÿæˆå™¨**: åŠ¨æ€ç”Ÿæˆç¼“å­˜é”®

### 4. ä¼šè¯ç®¡ç† (`src/services/sessionManager.ts`)

- **SessionManager**: ç”¨æˆ·ä¼šè¯ç®¡ç†
- **å¤šè®¾å¤‡æ”¯æŒ**: åŒä¸€ç”¨æˆ·å¤šä¸ªä¼šè¯
- **æ´»è·ƒåº¦è·Ÿè¸ª**: æœ€åæ´»è·ƒæ—¶é—´æ›´æ–°

### 5. çƒ­é—¨å†…å®¹ç¼“å­˜ (`src/services/hotContentCache.ts`)

- **HotContentCache**: çƒ­é—¨å†…å®¹æ’è¡Œ
- **å®æ—¶ç»Ÿè®¡**: æµè§ˆã€ç‚¹èµã€è¯„è®ºç­‰
- **åˆ†æ•°è®¡ç®—**: åŸºäºå¤šç»´åº¦çš„çƒ­åº¦ç®—æ³•

### 6. ç¼“å­˜ä¸­é—´ä»¶ (`src/middleware/cache.ts`)

- **è‡ªåŠ¨ç¼“å­˜**: APIå“åº”è‡ªåŠ¨ç¼“å­˜
- **æ¡ä»¶ç¼“å­˜**: åŸºäºæ¡ä»¶çš„ç¼“å­˜ç­–ç•¥
- **ç¼“å­˜æ¸…é™¤**: æ•°æ®æ›´æ–°åè‡ªåŠ¨æ¸…é™¤

### 7. ç¼“å­˜è£…é¥°å™¨ (`src/decorators/cache.ts`)

- **@Cache**: æ–¹æ³•çº§åˆ«çš„ç¼“å­˜è£…é¥°å™¨
- **@CacheEvict**: ç¼“å­˜æ¸…é™¤è£…é¥°å™¨
- **@CachePut**: ç¼“å­˜æ›´æ–°è£…é¥°å™¨

## åŠŸèƒ½ç‰¹æ€§

### ğŸš€ é«˜æ€§èƒ½ç¼“å­˜

- **å†…å­˜ç¼“å­˜**: åŸºäºRedisçš„é«˜é€Ÿå†…å­˜å­˜å‚¨
- **æ™ºèƒ½è¿‡æœŸ**: è‡ªåŠ¨TTLç®¡ç†å’Œæ¸…ç†
- **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡è¯»å†™æ“ä½œ
- **å‹ç¼©å­˜å‚¨**: JSONåºåˆ—åŒ–ä¼˜åŒ–

### ğŸ” ä¼šè¯ç®¡ç†

- **å¤šè®¾å¤‡ç™»å½•**: æ”¯æŒåŒä¸€ç”¨æˆ·å¤šè®¾å¤‡ä¼šè¯
- **ä¼šè¯è·Ÿè¸ª**: å®æ—¶è·Ÿè¸ªç”¨æˆ·æ´»è·ƒçŠ¶æ€
- **å®‰å…¨ç®¡ç†**: ä¼šè¯è¿‡æœŸå’Œå¼ºåˆ¶ä¸‹çº¿
- **è®¾å¤‡è¯†åˆ«**: è®¾å¤‡IDå’Œå¹³å°ä¿¡æ¯è®°å½•

### ğŸ“Š çƒ­é—¨å†…å®¹

- **å®æ—¶æ’è¡Œ**: åŸºäºç”¨æˆ·è¡Œä¸ºçš„å®æ—¶æ’è¡Œ
- **å¤šç»´åº¦ç»Ÿè®¡**: æµè§ˆã€ç‚¹èµã€è¯„è®ºã€åˆ†äº«ç­‰
- **åˆ†ç±»æ’è¡Œ**: æ”¯æŒæŒ‰åˆ†ç±»çš„çƒ­é—¨å†…å®¹
- **æ—¶é—´è¡°å‡**: è€ƒè™‘æ—¶é—´å› ç´ çš„çƒ­åº¦ç®—æ³•

### ğŸ¯ æ™ºèƒ½ç¼“å­˜

- **è‡ªåŠ¨ç¼“å­˜**: APIå“åº”è‡ªåŠ¨ç¼“å­˜
- **æ¡ä»¶ç¼“å­˜**: åŸºäºè¯·æ±‚æ¡ä»¶çš„ç¼“å­˜ç­–ç•¥
- **ç”¨æˆ·ç¼“å­˜**: ä¸ªæ€§åŒ–ç”¨æˆ·æ•°æ®ç¼“å­˜
- **æœç´¢ç¼“å­˜**: æœç´¢ç»“æœç¼“å­˜ä¼˜åŒ–

## ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç¼“å­˜æ“ä½œ

```typescript
import { cacheService } from '@/services/cache';

// è®¾ç½®ç¼“å­˜
await cacheService.set('user:123', userData, 3600); // 1å°æ—¶è¿‡æœŸ

// è·å–ç¼“å­˜
const userData = await cacheService.get('user:123');

// åˆ é™¤ç¼“å­˜
await cacheService.del('user:123');

// å“ˆå¸Œè¡¨æ“ä½œ
await cacheService.hset('user:123:profile', 'name', 'å¼ ä¸‰');
const name = await cacheService.hget('user:123:profile', 'name');
```

### ä¼šè¯ç®¡ç†

```typescript
import { sessionManager } from '@/services/sessionManager';

// åˆ›å»ºä¼šè¯
const session = await sessionManager.createSession('user123', {
  deviceId: 'device001',
  platform: 'mobile',
  ip: '192.168.1.100'
});

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨çº¿
const isOnline = await sessionManager.isUserOnline('user123');

// é”€æ¯ä¼šè¯
await sessionManager.destroySession(session.sessionId);
```

### çƒ­é—¨å†…å®¹

```typescript
import { hotContentCache } from '@/services/hotContentCache';

// æ›´æ–°å†…å®¹ç»Ÿè®¡
await hotContentCache.updateContentStats('work001', 'work', {
  views: 1000,
  likes: 150,
  comments: 25
});

// è·å–çƒ­é—¨å†…å®¹
const hotWorks = await hotContentCache.getHotContent('work', 10);
```

### ç¼“å­˜ä¸­é—´ä»¶

```typescript
import { cacheMiddleware, userCacheMiddleware } from '@/middleware/cache';

// é€šç”¨ç¼“å­˜ä¸­é—´ä»¶
app.get('/api/works', cacheMiddleware({ ttl: 300 }), getWorksHandler);

// ç”¨æˆ·ç›¸å…³ç¼“å­˜
app.get('/api/user/profile', userCacheMiddleware({ ttl: 600 }), getUserProfileHandler);

// çƒ­é—¨å†…å®¹ç¼“å­˜
app.get('/api/works/hot', hotContentCacheMiddleware('works'), getHotWorksHandler);
```

### ç¼“å­˜è£…é¥°å™¨

```typescript
import { Cache, CacheEvict } from '@/decorators/cache';

class UserService {
  @Cache({ key: 'user:profile', ttl: 3600, serializeArgs: true })
  async getUserProfile(userId: string) {
    // æ–¹æ³•ç»“æœä¼šè‡ªåŠ¨ç¼“å­˜
    return await this.database.findUser(userId);
  }

  @CacheEvict(['user:profile:*', 'user:list:*'])
  async updateUser(userId: string, data: any) {
    // æ›´æ–°åè‡ªåŠ¨æ¸…é™¤ç›¸å…³ç¼“å­˜
    return await this.database.updateUser(userId, data);
  }
}
```

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

```bash
# Redisé…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_KEY_PREFIX=dongpaidi:
REDIS_URL=redis://localhost:6379
```

### ç¼“å­˜ç­–ç•¥

| æ•°æ®ç±»å‹ | TTL | è¯´æ˜ |
|---------|-----|------|
| ç”¨æˆ·ä¿¡æ¯ | 1å°æ—¶ | ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ç¼“å­˜ |
| ä½œå“åˆ—è¡¨ | 5åˆ†é’Ÿ | ä½œå“åˆ—è¡¨é¡µé¢ç¼“å­˜ |
| çƒ­é—¨å†…å®¹ | 30åˆ†é’Ÿ | çƒ­é—¨æ’è¡Œæ¦œç¼“å­˜ |
| æœç´¢ç»“æœ | 10åˆ†é’Ÿ | æœç´¢ç»“æœç¼“å­˜ |
| ç»Ÿè®¡æ•°æ® | 1å°æ—¶ | ç³»ç»Ÿç»Ÿè®¡æ•°æ®ç¼“å­˜ |
| ç”¨æˆ·ä¼šè¯ | 7å¤© | ç”¨æˆ·ç™»å½•ä¼šè¯ |

## ç›‘æ§å’Œç»´æŠ¤

### ç¼“å­˜ç»Ÿè®¡

```typescript
// è·å–ç¼“å­˜å‘½ä¸­ç‡
const stats = await cacheService.get('cache:stats');

// è·å–RedisçŠ¶æ€
const status = await RedisInitializer.getRedisStatus();

// å¥åº·æ£€æŸ¥
const health = await RedisInitializer.healthCheck();
```

### å®šæ—¶ä»»åŠ¡

- **ä¼šè¯æ¸…ç†**: æ¯5åˆ†é’Ÿæ¸…ç†è¿‡æœŸä¼šè¯
- **çƒ­é—¨å†…å®¹åˆ·æ–°**: æ¯30åˆ†é’Ÿåˆ·æ–°çƒ­é—¨æ’è¡Œ
- **ç¼“å­˜ç»Ÿè®¡**: æ¯å°æ—¶æ›´æ–°ç¼“å­˜ç»Ÿè®¡æ•°æ®

### æ•…éšœå¤„ç†

1. **Redisè¿æ¥å¤±è´¥**: è‡ªåŠ¨åˆ‡æ¢åˆ°Mock RedisæœåŠ¡
2. **ç¼“å­˜ç©¿é€**: ä½¿ç”¨ç©ºå€¼ç¼“å­˜é˜²æ­¢ç©¿é€
3. **ç¼“å­˜é›ªå´©**: éšæœºTTLé˜²æ­¢åŒæ—¶è¿‡æœŸ
4. **ç¼“å­˜å‡»ç©¿**: åˆ†å¸ƒå¼é”é˜²æ­¢å¹¶å‘é‡å»º

## æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜é¢„çƒ­

```typescript
// åº”ç”¨å¯åŠ¨æ—¶é¢„çƒ­å¸¸ç”¨æ•°æ®
await RedisInitializer.initialize();
```

### æ‰¹é‡æ“ä½œ

```typescript
// æ‰¹é‡è·å–ç”¨æˆ·æ•°æ®
const userIds = ['1', '2', '3'];
const users = await cacheService.getBatchContentStats(userIds, 'user');
```

### å†…å­˜ä¼˜åŒ–

- ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„ï¼ˆå“ˆå¸Œè¡¨ vs å­—ç¬¦ä¸²ï¼‰
- è®¾ç½®åˆç†çš„TTLé¿å…å†…å­˜æ³„æ¼
- å®šæœŸæ¸…ç†è¿‡æœŸé”®

## æœ€ä½³å®è·µ

1. **é”®å‘½åè§„èŒƒ**: ä½¿ç”¨CacheKeysç»Ÿä¸€ç®¡ç†
2. **TTLè®¾ç½®**: æ ¹æ®æ•°æ®æ›´æ–°é¢‘ç‡è®¾ç½®åˆç†TTL
3. **ç¼“å­˜å±‚çº§**: å¤šçº§ç¼“å­˜ç­–ç•¥ï¼ˆå†…å­˜ + Redisï¼‰
4. **é”™è¯¯å¤„ç†**: ç¼“å­˜å¤±è´¥ä¸å½±å“ä¸šåŠ¡é€»è¾‘
5. **ç›‘æ§å‘Šè­¦**: ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡å’Œæ€§èƒ½æŒ‡æ ‡

## æµ‹è¯•

```bash
# è¿è¡Œç¼“å­˜ç³»ç»Ÿæµ‹è¯•
npm run test:cache

# æˆ–è€…ç›´æ¥è¿è¡Œæµ‹è¯•è„šæœ¬
npx ts-node src/test-cache-simple.ts
```

## éƒ¨ç½²è¯´æ˜

### å¼€å‘ç¯å¢ƒ

- ä½¿ç”¨Mock RedisæœåŠ¡ï¼Œæ— éœ€å®‰è£…Redis
- è‡ªåŠ¨å†…å­˜æ¸…ç†å’Œè¿‡æœŸå¤„ç†

### ç”Ÿäº§ç¯å¢ƒ

- éƒ¨ç½²RedisæœåŠ¡å™¨æˆ–ä½¿ç”¨äº‘RedisæœåŠ¡
- é…ç½®RedisæŒä¹…åŒ–å’Œé«˜å¯ç”¨
- ç›‘æ§Redisæ€§èƒ½å’Œå†…å­˜ä½¿ç”¨

---

**æ³¨æ„**: æœ¬ç¼“å­˜ç³»ç»Ÿæ”¯æŒåœ¨æ²¡æœ‰RedisæœåŠ¡å™¨çš„æƒ…å†µä¸‹ä½¿ç”¨Mock RedisæœåŠ¡ï¼Œç¡®ä¿å¼€å‘ç¯å¢ƒçš„ä¾¿åˆ©æ€§ã€‚
